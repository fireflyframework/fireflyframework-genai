name: Desktop Build

on:
  push:
    tags: ['desktop-v*']

permissions:
  contents: write

jobs:
  build-sidecar:
    name: Build Sidecar
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - uses: astral-sh/setup-uv@e58605a9b6da7c637471fab8847a5e5a6b8df081 # v5
        with:
          enable-cache: true

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm
          cache-dependency-path: studio-frontend/package-lock.json

      - name: Build frontend
        run: npm ci && npm run build
        working-directory: studio-frontend

      - name: Bundle frontend into static dir
        run: uv run python scripts/build_studio.py

      - name: Install PyInstaller and deps
        run: uv sync --extra studio && uv pip install pyinstaller

      - name: Build sidecar
        run: uv run pyinstaller studio-desktop/pyinstaller/firefly_studio.spec --noconfirm

      - uses: actions/upload-artifact@v4
        with:
          name: firefly-studio-sidecar
          path: dist/firefly-studio/
          retention-days: 1

  build-tauri:
    name: Build Desktop App
    needs: build-sidecar
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: firefly-studio-sidecar
          path: studio-desktop/src-tauri/sidecar/

      - name: Make sidecar executable
        run: chmod +x studio-desktop/src-tauri/sidecar/firefly-studio

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2"

      - name: Build Tauri app
        run: cargo tauri build
        working-directory: studio-desktop

      - uses: actions/upload-artifact@v4
        with:
          name: desktop-macos-arm64
          path: studio-desktop/src-tauri/target/release/bundle/dmg/*.dmg
          retention-days: 3

  release-desktop:
    name: Create Desktop Release
    needs: build-tauri
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: desktop-macos-arm64
          path: artifacts/

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          shopt -s nullglob
          files=(artifacts/*.dmg)
          if [ ${#files[@]} -gt 0 ]; then
            gh release create "$TAG_NAME" "${files[@]}" --generate-notes --title "Firefly Studio Desktop $TAG_NAME"
          else
            gh release create "$TAG_NAME" --generate-notes --title "Firefly Studio Desktop $TAG_NAME"
          fi
